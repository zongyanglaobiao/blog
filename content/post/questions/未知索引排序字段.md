---
title: "unknown index sort field:xx"
description: åœ¨SpringBootæ•´åˆelasticsearchæ—¶ä½¿ç”¨@Settingï¼Œå‡ºç°unknown index sort field:[address]
# é»˜è®¤urlè·¯å¾„æ˜¯titleå¦‚æœä¸å†™slug
slug: questions2
date: 2024-08-19 21:55:56+0000
toc: true
categories:
  - bug-category
tags:
  - SpringBoot
  - ElasticSearch
keywords:
  - SpringBoot
  - ElasticSearch
---

## åœºæ™¯å†ç°

>  [spring-boot-data-elasticå®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-data/elasticsearch/reference/elasticsearch/object-mapping.html)

**ç‰ˆæœ¬**

1. elasticsearch 8.15.0
2. springboot 3.0.2

**POMä¾èµ–**

```xml
<!--  elasticsearchå®¢æˆ·ç«¯     -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶**

```yml
spring:
  elasticsearch:
    password: XXl@20030711
    username: elastic
    uris: http://localhost:9200
```

**å®ä½“ç±»**

```java
public static final String INDEX_NAME = "mysql";

@Document(indexName = INDEX_NAME)
@Data
@Setting(
        sortFields = "address",
        sortModes = Setting.SortMode.max,
        sortOrders = Setting.SortOrder.asc,
        sortMissingValues = {  Setting.SortMissing._first }
)
private static class User{
    @Id
    private String id;
    @Field(type = FieldType.Text,analyzer = "ik_smart")
    @HighlightField(parameters = @HighlightParameters(preTags = "<b>",postTags = "</b>"))
    private String name;
    @Field(type = FieldType.Text,analyzer = "ik_smart")
    @HighlightField(parameters = @HighlightParameters(preTags = "<b>",postTags = "</b>"))
    private String nickName;
    @Field(type = FieldType.Text,index = false)
    private String pwd;
    @Field(type = FieldType.Keyword)
    private String address;
    @Field(type = FieldType.Date,index = false,format = DateFormat.date_hour_minute_second)
    private LocalDateTime createTime;
    @Field(type = FieldType.Date,index = false,format = DateFormat.date_hour_minute_second)
    private LocalDateTime updateTime;
    @Field(type = FieldType.Nested)
    private List<UserRole> roles;
}

@Data
@Accessors(chain = true)
private final static class UserRole{
    @Id
    private String id;
    @Field(type = FieldType.Text,analyzer = "ik_smart")
    private String roleEN;
    @Field(type = FieldType.Text)
    private String roleCN;
    @Field(type = FieldType.Integer,index = false)
    private Integer roleCode;
}
```
**æµ‹è¯•ç±»**

```java
@SpringBootTest
public class Test {

    public static final String INDEX_NAME = "mysql";
    
    @Resource
    private ElasticsearchTemplate elasticsearchTemplate;

    @Resource
    private ElasticsearchClient elasticsearchClient;
    
    @Test
    void test() throws IOException, InterruptedException {
        //åˆ é™¤ç´¢å¼•    
        if (elasticsearchTemplate.indexOps(User.class).exists()) {
            elasticsearchClient.indices().delete(DeleteIndexRequest.of(builder -> builder.index(INDEX_NAME)));
        }
        //åˆ›å»ºç´¢å¼•    
        elasticsearchTemplate.indexOps(User.class).create();
        //æ’å…¥æ–‡æ¡£ï¼ŒMockUserBuilder.Builderæ˜¯ç”¨äºæ„å»ºUserå¯¹è±¡æ— å…³è¿™æ¬¡çš„Bug
        MockUserBuilder.Builder builder = new MockUserBuilder.Builder();
        elasticsearchTemplate.save(List.of(builder.build(),builder.build(),builder.build()));
        //æœç´¢æŒ‡å®šç´¢å¼•ä¸‹çš„æ‰€æœ‰æ–‡æ¡£,ç³»ç»Ÿç­‰å¾…1ç§’å› ä¸ºæŸ¥è¯¢ä¸ºç©ºï¼Œå› ä¸ºæŸ¥è¯¢æ—¶å¯èƒ½æ­£åœ¨æ’å…¥  
        Thread.sleep(1000);
        SearchHits<User> search = elasticsearchTemplate.search(Query.findAll(),User.class);
        search.forEach(System.out::println);
    }
}   
```

**æ‰§è¡Œå¦‚æœå¦‚ä¸‹ï¼š**

```text
Caused by: co.elastic.clients.elasticsearch._types.ElasticsearchException: [es/indices.create] failed: [illegal_argument_exception] unknown index sort field:[address]
	at co.elastic.clients.transport.rest_client.RestClientTransport.getHighLevelResponse(RestClientTransport.java:282)
	at co.elastic.clients.transport.rest_client.RestClientTransport.performRequest(RestClientTransport.java:148)
	at co.elastic.clients.elasticsearch.indices.ElasticsearchIndicesClient.create(ElasticsearchIndicesClient.java:266)
	at org.springframework.data.elasticsearch.client.elc.IndicesTemplate.lambda$doCreate$0(IndicesTemplate.java:138)
	at org.springframework.data.elasticsearch.client.elc.ChildTemplate.execute(ChildTemplate.java:71)
	... 73 more
```

ä¹Ÿå°±æ˜¯å‡ºç°`unknown index sort field:[address]`é—®é¢˜ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œ`sortFields`ä½¿ç”¨çš„Javaå¯¹è±¡çš„å±æ€§åè€Œä¸æ˜¯ä¸ºelasticsearchåˆ›å»ºçš„åå­—ï¼Œ**è€Œæˆ‘çš„å†™æ³•åŸºæœ¬å’Œå®˜æ–¹ä¸€æ ·**ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜è®©æˆ‘æ‘¸ä¸åˆ°å¤´è„‘

![img_1](img/questions/2/img_1.png)

## å…·ä½“é—®é¢˜

DEBUGæºç åœ¨ElasticsearchIndicesClientç±»createæ–¹æ³•å‘ç°é—®é¢˜
```java
public CreateIndexResponse create(CreateIndexRequest request) throws IOException, ElasticsearchException {
    @SuppressWarnings("unchecked")
    JsonEndpoint<CreateIndexRequest, CreateIndexResponse, ErrorResponse> endpoint = (JsonEndpoint<CreateIndexRequest, CreateIndexResponse, ErrorResponse>) CreateIndexRequest._ENDPOINT;

    return this.transport.performRequest(request, endpoint, this.transportOptions);
}
```

åœ¨åˆæ¬¡åˆ›å»ºç´¢å¼•çš„æ—¶å€™å‘ç°requestå‘é€è¯·æ±‚çš„å†…å®¹æ²¡æœ‰**mappingsä¿¡æ¯**ï¼Œæ²¡æœ‰`mappings`ä¿¡æ¯ï¼Œä½†æ˜¯**setting**ä¿¡æ¯åˆå­˜åœ¨å¯¼è‡´æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å­—æ®µ

```text
CreateIndexRequest: PUT /mysql 
{"settings":
    {
        "index":
        {"sort":
            {"field":["address"],
             "order":["asc"],"mode":["max"]},
        "number_of_shards":"1",
        "number_of_replicas":"1",
        "refresh_interval":"1s"}}
}
```

æƒ³åœ¨**æ’å…¥æ•°æ®ä¹‹å‰æœ‰`mappings`ä¿¡æ¯ï¼Œå°±åˆ é™¤@Settingæ³¨è§£**ï¼Œä½†å¹¶æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œå› ä¸ºæ’åºè§„åˆ™æ˜¯è·Ÿ`mappings`ç»‘å®šçš„ä¸èƒ½è¯´ä¸€ä¼šåˆ ä¸€ä¼šå†åŠ `settings`å†æ›´æ–°`Index`
```java
//åˆ›å»ºç´¢å¼•
elasticsearchTemplate.indexOps(User.class).create();
elasticsearchTemplate.indexOps(User.class).putMapping();
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€

ä½¿ç”¨`createWithMapping`æ–¹æ³•ï¼Œäº²æµ‹æœ‰æ•ˆ

```java
//åˆ›å»ºç´¢å¼•
elasticsearchTemplate.indexOps(User.class).createWithMapping();
```

### å…¶ä»–æ–¹æ¡ˆ

è¿˜æœ‰å…¶ä»–æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘éƒ½**æ²¡æµ‹è¯•è¿‡**

1. æ‰‹åŠ¨ä¼ é€’ mappingsï¼Œæ‰‹åŠ¨è°ƒç”¨ putMapping æ–¹æ³•æ¥ç¡®ä¿ mappings åœ¨ç´¢å¼•åˆ›å»ºæ—¶è¢«æ­£ç¡®åº”ç”¨ã€‚

    ```java
    IndexOperations indexOps = elasticsearchTemplate.indexOps(User.class);
    if (!indexOps.exists()) {
    // åˆ›å»ºç´¢å¼•å¹¶å¸¦ä¸Š settings
    indexOps.create(indexOps.createSettings(User.class));
    
        // æ‰‹åŠ¨åº”ç”¨ mappings
        indexOps.putMapping(indexOps.createMapping(User.class));
    }
    ```
è¿™é‡Œæˆ‘æƒ³åæ§½ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œå°±æ˜¯æ¢ä¸ªæ–¹æ³•çš„äº‹è€—äº†åŠå¤©ï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯æ³¨è§£ä½¿ç”¨ä¸å½“çš„é—®é¢˜ğŸ˜…
